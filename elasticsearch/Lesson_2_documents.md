# Документы

> Elasticsearch является документ ориентированной базой данных, 
> поэтому данные в ней хранятся в виде документов.

    Документ представляет из себя отдельный файл в виде json объекта

Использовать такой подход очень удобно, поскольку все нужные данные находятся в самом документе, 
и нет зависимостей, как в sql. Документы можно перемещать между шардами, что позволяет легко масштабировать базу.

## Добавление документа в индекс (индексирование)

Для добавления используется POST запрос:

```json
POST /index_name/_doc
{
  "name": "Alex",
  "role": "Dev",
  "age": 27
} 
```

Разберём ответ запроса:

```json
{
  "_index" : "products",
  "_type" : "_doc",
  "_id" : "QmApW3wBEeaRWyg6pnAi",
  "_version" : 1,
  "result" : "created",
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "_seq_no" : 0,
  "_primary_term" : 1
}
```

`total shard` - кол-во шардов в индексе

`successful shard` - кол-во успешных шардов, в которые добавился документ

> В данном случае было два шарда: мастер и реплика. Но поскольку нода одна,
> то реплика шард не работает, поэтому документ добавился только в мастер шард

`_id` - автоматически сгенерированный id

Для того чтобы подставить свой id, необходимо изменить метод запроса на PUT и добавить в конце свой id:

```json
PUT /{index_name}/_doc/100
{
  "name": "Greg",
  "role": "Ops",
  "age": 32
}
```

>При добавлении документа в несуществующий индекс - он создастся автоматически.
> За это отвечает опция в конфиге `action.auto_create_index`. Это плохая практика, индексы лучше создавать вручную.


## Получение документа

Получить документ из индекса можно по его id 

```json
GET /{index_name}/_doc/{id}
```

Данные документа будут находиться в поле `_source`

`found` - поле, означающее, что документ найден

## Обновление документа

При обновлении так же можно добавлять новые поля

>На самом деле документы иммутабельны, то есть неизменны.
>Обновление происходит за счёт полной замены документа на новый.
>Но вся работа скрыта за updates API. Мы можем вручную получить документ, взять оттуда поля,
>и создать новый документ с тем же id. Но проще использовать updates API.

```json
POST /{index_name}/_update/{id}
{
  "doc": {
    "name": "Alexum"
  } 
}
```

`script` - параметр, позволяющий выполнять логические операции над полями 
при обновлении документа

Так же существует параметр `upserts` в updates API. В нём находится новый документ,
который создаётся, если документа нет.
Если же документ есть, то вместо него вызываются другие поля, как `scripts`

### Множественное обновление с помощью query запроса
```json
POST /products/_update_by_query
{
  "query": {
    "match_all": {}
  } 
}
```

## Удаление документа

```json
DELETE /{index_name}/_doc/{id}
```

### Множественное удаление с помощью query запроса
```json
POST /products/_delete_by_query
{
  "query": {
    "match_all": {}
  } 
}
```

## Множественная обработка

> Каждая строка - json. Одна строка - метаинформация (метод, индекс и т.д.),
> следующая строка - передаваемые данные

```json
POST /_bulk
{ "index": { "_index": "products", "_id": 101 } }
{ "name": "Sumoil", "role": "Muchacha", "age": 40 }
{ "create": { "_index": "products", "_id": 102 } }
{ "name": "Pitren", "role": "Mage", "age": 500 }
{ "delete": { "_index": "products", "_id": 100} }
```

> Индекс так же можно передавать не в метаданных, а в строке запроса

```json
POST /{index_name}/_bulk
{...}
```